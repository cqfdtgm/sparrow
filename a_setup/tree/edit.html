## 0_setup/user/default.html
<%inherit file="default.html" />

${parent.body()}

<%block name="js">
<script type="text/javascript">
    function showPageNation(node) {
        if (node.children==undefined){return;}
        if (node.total > node.children.length) {
            $('#pp').remove();
            pp = $('<div id="pp" style="position:relative;top:-6px;float:right"></div>').appendTo(node.target);
            pp.pagination({layout:['prev', 'links', 'next'], displayMsg:'', total:node.total, pageSize:node.pagesize
                ,nodeId:node.id ,pageNumber: (node.pageNumber?node.pageNumber:1)
                ,onSelectPage: function(pageNumber, pageSize) {
                    opts = $('#tr').tree('options');
                    data = $.ajax({ url: opts.url, type: 'post', dataType: 'json', async: false,
                        data: { id: node.id ,rows: pageSize ,page: pageNumber }
                    }).responseJSON;
                    if (data.isError) {
                        $.messager.show(data);
                    } else {
                        $.each($('#tr').tree('getChildren', node.target), function (n, node2) {
                                $('#tr').tree('remove', node2.target);
                            }
                        );
                        node.pageNumber = pageNumber;
                        //node.total = data.total;
                        $.each(data['rows'], function (n, data) {
                            $('#tr').tree('append', { parent: (node ? node.target : null), data: data });
                        });
                        $('#tr').tree('select', node.target);
                    }
                }
            });
        }
    }
    $(function(){
	$('#tr').etree({
	    url: "tree?table=${table}" ,method: "get" ,checkbox:false ,lines:true
	    ,dnd:true	//拖动太容易出错了，特别是在手机上。
	    //  前端想禁止追加或拖动后突破下级数量限制，脚本过于复杂，统一通过后端判断后端返回值来处理。
        ,loadFilter: function(data) {
            //console.log('data:', data);
		    if (data.d) {
                return data.d;
            } else if (data.total) {    // 如果返回的是select形式，表明需要翻页
                parentNode = $(this).tree('find', data.rows[0].parentid);
                console.log('par:', parentNode, data.rows[0]);
                if (parentNode) {
                    parentNode.total = data.total;
                    parentNode.pagesize = data.pagesize;
                } else {    // 是顶层目录，如果记录数超过一——显示翻页插件
                    console.log('dis pp0', $('#pp0'));
                    $('#pp0').css({visibility:"visible"}).pagination({
                        total:data.total, pageSize: data.pagesize
                        ,onSelectPage: function(pageNumber, pageSize) {
                            $('#tr').tree({queryParams: {rows:pageSize, page:pageNumber}});
                        }
                    });
                }
                return data.rows;
		    } else {
                return data;
		    }
		}
	    ,formatter: function(node) {
		    return node.id + ': ' +  node.text + ' ' + node.state + ' ' + node.display;
		    }
		,onExpand: function(node) {
		    showPageNation(node);
		}
		,onSelect: function(node) { // 选中一个节点时，关闭所有翻页栏，只打开本节点的翻页栏（如果有的话）
		    showPageNation(node);
		}
	});
	$('#dg').hide();
    });
</script>
</%block>

<%block name="toolbutton">
    <div style="display:inline-block;position:relative;top:-13px">
    <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="javascript:$('#tr').etree('create')"></a>
    <a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="javascript:$('#tr').etree('destroy')" title="删除目前选中行" ></a>
    <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="javascript:$('#tr').etree('edit')" title="双击亦可进入编辑模式"></a>
    <a href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true" onclick="javascript:$('#tr').etree('endEdit')" title="回车亦可进行保存"></a>
    <a href="#" class="easyui-linkbutton" disabled="true" iconCls="icon-undo" plain="true" onclick="javascript:$('#tr').etree('cancelEdit')" title="取消编辑，不可点按此键，必须按ESC键才能取消"></a>
    <a href="#" class="easyui-linkbutton" iconCls="icon-reload" plain="true" onclick="javascript:$('#tr').etree('reload')" title=""></a>
    </div>
    <div id="pp0" class="easyui-pagination" data-options="layout:['prev','links','next'],displayMsg:''"
         style="position:relative;left:20px;display:inline-block;visibility:hidden" ></div>
</%block>


